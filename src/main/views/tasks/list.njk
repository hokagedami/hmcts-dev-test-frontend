{% extends "template.njk" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}

{% block pageTitle %}Tasks - Task Management{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    {% if success == 'created' %}
      {{ govukNotificationBanner({
        type: "success",
        text: "Task created successfully."
      }) }}
    {% elif success == 'deleted' %}
      {{ govukNotificationBanner({
        type: "success",
        text: "Task deleted successfully."
      }) }}
    {% endif %}

    {% if error %}
      {{ govukNotificationBanner({
        text: "There was a problem loading the tasks. Please try again."
      }) }}
    {% endif %}

    <h1 class="govuk-heading-xl">Tasks</h1>

    <div class="govuk-grid-row govuk-!-margin-bottom-6">
      <div class="govuk-grid-column-two-thirds">
        <form method="get" action="/tasks" class="govuk-!-margin-bottom-4">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-one-third">
              {{ govukSelect({
                id: "status",
                name: "status",
                label: {
                  text: "Status"
                },
                items: [
                  { value: "", text: "All statuses", selected: filters.status == "" },
                  { value: "PENDING", text: "Pending", selected: filters.status == "PENDING" },
                  { value: "IN_PROGRESS", text: "In Progress", selected: filters.status == "IN_PROGRESS" },
                  { value: "COMPLETED", text: "Completed", selected: filters.status == "COMPLETED" },
                  { value: "CANCELLED", text: "Cancelled", selected: filters.status == "CANCELLED" }
                ]
              }) }}
            </div>
            <div class="govuk-grid-column-one-third">
              {{ govukSelect({
                id: "priority",
                name: "priority",
                label: {
                  text: "Priority"
                },
                items: [
                  { value: "", text: "All priorities", selected: filters.priority == "" },
                  { value: "LOW", text: "Low", selected: filters.priority == "LOW" },
                  { value: "MEDIUM", text: "Medium", selected: filters.priority == "MEDIUM" },
                  { value: "HIGH", text: "High", selected: filters.priority == "HIGH" },
                  { value: "URGENT", text: "Urgent", selected: filters.priority == "URGENT" }
                ]
              }) }}
            </div>
            <div class="govuk-grid-column-one-third">
              <div class="govuk-form-group">
                <label class="govuk-label">&nbsp;</label>
                {{ govukButton({
                  text: "Filter",
                  classes: "govuk-button--secondary"
                }) }}
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="govuk-grid-column-one-third govuk-!-text-align-right">
        {{ govukButton({
          text: "Create task",
          href: "/tasks/create"
        }) }}
      </div>
    </div>

    {% if tasks.length > 0 %}
      <table class="govuk-table">
        <caption class="govuk-table__caption govuk-table__caption--m govuk-visually-hidden">Task list</caption>
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header">Title</th>
            <th scope="col" class="govuk-table__header">Status</th>
            <th scope="col" class="govuk-table__header">Priority</th>
            <th scope="col" class="govuk-table__header">Due Date</th>
            <th scope="col" class="govuk-table__header">Actions</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          {% for task in tasks %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">
                <a href="/tasks/{{ task.id }}" class="govuk-link">{{ task.title }}</a>
              </td>
              <td class="govuk-table__cell">
                {{ govukTag({
                  text: task.statusDisplay,
                  classes: task.statusTagColor
                }) }}
              </td>
              <td class="govuk-table__cell">
                {{ govukTag({
                  text: task.priorityDisplay,
                  classes: task.priorityTagColor
                }) }}
              </td>
              <td class="govuk-table__cell">{{ task.formattedDueDate }}</td>
              <td class="govuk-table__cell">
                <a href="/tasks/{{ task.id }}" class="govuk-link govuk-!-margin-right-2">View</a>
                <a href="/tasks/{{ task.id }}/edit" class="govuk-link govuk-!-margin-right-2">Edit</a>
                <a href="/tasks/{{ task.id }}/delete" class="govuk-link govuk-link--no-visited-state">Delete</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if pagination.totalPages > 1 %}
        <nav class="govuk-pagination" role="navigation" aria-label="results">
          {% if pagination.currentPage > 0 %}
            <div class="govuk-pagination__prev">
              <a class="govuk-link govuk-pagination__link" href="/tasks?page={{ pagination.currentPage - 1 }}&status={{ filters.status }}&priority={{ filters.priority }}" rel="prev">
                <svg class="govuk-pagination__icon govuk-pagination__icon--prev" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                  <path d="m6.5938-0.0078125-6.7266 6.7266 6.7441 6.4062 1.377-1.449-4.1856-3.9768h12.896v-2h-12.984l4.2931-4.293-1.414-1.414z"></path>
                </svg>
                <span class="govuk-pagination__link-title">Previous</span>
              </a>
            </div>
          {% endif %}

          <ul class="govuk-pagination__list">
            {% for i in range(0, pagination.totalPages) %}
              <li class="govuk-pagination__item {% if i == pagination.currentPage %}govuk-pagination__item--current{% endif %}">
                <a class="govuk-link govuk-pagination__link" href="/tasks?page={{ i }}&status={{ filters.status }}&priority={{ filters.priority }}" aria-label="Page {{ i + 1 }}" {% if i == pagination.currentPage %}aria-current="page"{% endif %}>
                  {{ i + 1 }}
                </a>
              </li>
            {% endfor %}
          </ul>

          {% if pagination.currentPage < pagination.totalPages - 1 %}
            <div class="govuk-pagination__next">
              <a class="govuk-link govuk-pagination__link" href="/tasks?page={{ pagination.currentPage + 1 }}&status={{ filters.status }}&priority={{ filters.priority }}" rel="next">
                <span class="govuk-pagination__link-title">Next</span>
                <svg class="govuk-pagination__icon govuk-pagination__icon--next" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                  <path d="m8.107-0.0078125-1.4136 1.414 4.2926 4.293h-12.986v2h12.896l-4.1855 3.9766 1.377 1.4492 6.7441-6.4062-6.7246-6.7266z"></path>
                </svg>
              </a>
            </div>
          {% endif %}
        </nav>
      {% endif %}

      <p class="govuk-body govuk-!-margin-top-4">
        Showing {{ tasks.length }} of {{ pagination.totalElements }} tasks
      </p>
    {% else %}
      <p class="govuk-body">No tasks found. <a href="/tasks/create" class="govuk-link">Create your first task</a>.</p>
    {% endif %}

  </div>
</div>
{% endblock %}
